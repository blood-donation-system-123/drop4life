<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DROP4Life — Demo</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;color:#222;margin:0;padding:0}
    header{background:#c62828;color:#fff;padding:20px;text-align:center}
    .container{max-width:980px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:8px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    label{display:block;margin:8px 0;font-size:14px}
    input,select,button{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px}
    button{background:#c62828;color:#fff;border:none;cursor:pointer}
    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    footer{text-align:center;padding:12px;color:#666}
    #matches div{border:1px solid #eee;padding:8px;margin:8px 0;}
  </style>
</head>
<body>
  <header>
    <h1>DROP4Life (Demo)</h1>
    <div>Simple donor registration & request prototype — data saved locally in browser</div>
  </header>

  <main class="container">
    <section class="flex">
      <div class="card col">
        <h2>Register as Donor</h2>
        <form id="donorForm">
          <label>Name<input id="donorName" required /></label>
          <label>Blood Group
            <select id="donorBlood" required>
              <option value="">Select</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
            </select>
          </label>
          <label>City<input id="donorCity" required /></label>
          <label>Contact<input id="donorContact" required /></label>
          <label>Availability
            <select id="donorAvail" required>
              <option value="available">Available</option>
              <option value="unavailable">Unavailable</option>
            </select>
          </label>
          <button type="submit">Register Donor</button>
        </form>
      </div>

      <div class="card col">
        <h2>Request Blood</h2>
        <form id="requestForm">
          <label>Required Blood Group
            <select id="reqBlood" required>
              <option value="">Select</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
            </select>
          </label>
          <label>City<input id="reqCity" required /></label>
          <label>Urgency
            <select id="reqUrgency"><option value="normal">Normal</option><option value="urgent">Urgent</option></select>
          </label>
          <label>Your Contact<input id="reqContact" required /></label>
          <button type="submit">Find Donors</button>
        </form>
      </div>
    </section>

    <div class="card" id="results">
      <h2>Results & History</h2>
      <div id="messages">Donors registered: 0</div>
      <div id="matches"></div>
      <ul id="historyList"></ul>
    </div>
  </main>

  <footer>Demo: data kept locally in your browser. For production, a server & database are required.</footer>

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkBL-z3h16AxHRkgAMEjti95S8dCi2JNE&libraries=places"></script>

  <script>
    const DONOR_KEY = 'drop4life_donors';
    const REQ_KEY = 'drop4life_requests';
    const uid = ()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    const load = (k)=> JSON.parse(localStorage.getItem(k)||'[]');
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

    function refresh() {
      const donors = load(DONOR_KEY);
      document.getElementById('messages').innerText = 'Donors registered: '+donors.length;
      const reqs = load(REQ_KEY);
      const h = document.getElementById('historyList'); h.innerHTML='';
      if(reqs.length===0) h.innerHTML='<li>No requests yet</li>';
      reqs.forEach(r=>{
        const li=document.createElement('li');
        li.textContent = r.blood+' in '+r.city+' — '+(r.urgency||'normal');
        h.appendChild(li);
      });
    }

    // Register donor
    document.getElementById('donorForm').addEventListener('submit', e=>{
      e.preventDefault();
      const d = { 
        id:uid(), 
        name:document.getElementById('donorName').value.trim(),
        blood:document.getElementById('donorBlood').value, 
        city:document.getElementById('donorCity').value.trim().toLowerCase(),
        contact:document.getElementById('donorContact').value.trim(), 
        avail:document.getElementById('donorAvail').value 
      };
      const arr = load(DONOR_KEY); arr.push(d); save(DONOR_KEY,arr); alert('Donor saved (demo)'); e.target.reset(); refresh();
    });

    // Request blood
    document.getElementById('requestForm').addEventListener('submit', e=>{
      e.preventDefault();
      const r = { 
        id:uid(), 
        blood:document.getElementById('reqBlood').value, 
        city:document.getElementById('reqCity').value.trim().toLowerCase(),
        urgency:document.getElementById('reqUrgency').value, 
        contact:document.getElementById('reqContact').value, 
        time:new Date().toISOString()
      };
      const arr = load(REQ_KEY); arr.unshift(r); save(REQ_KEY,arr); 
      alert('Search started (demo)'); 
      findAndShow(r); 
      e.target.reset(); 
      refresh();
    });

    // Convert city to coordinates
    async function getCoordinates(city){
      return new Promise((resolve,reject)=>{
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({address: city}, (results, status)=>{
          if(status === 'OK' && results[0]){
            resolve(results[0].geometry.location);
          } else {
            resolve(null);
          }
        });
      });
    }

    async function findAndShow(request){
      const donors = load(DONOR_KEY).filter(d=>d.avail==='available' && d.blood===request.blood);
      const resultsBox = document.getElementById('matches');
      resultsBox.innerHTML = '';

      const reqCoord = await getCoordinates(request.city);
      if(!reqCoord){ resultsBox.innerHTML="<p>Invalid city name.</p>"; return; }

      // Filter donors within ~50km radius
      const filtered = [];
      for(const d of donors){
        const donorCoord = await getCoordinates(d.city);
        if(donorCoord){
          const distance = google.maps.geometry.spherical.computeDistanceBetween(reqCoord, donorCoord)/1000; // km
          if(distance<=50){ // within 50 km
            filtered.push({...d, distance:distance.toFixed(1)});
          }
        }
      }

      if(filtered.length===0){ resultsBox.innerHTML="<p>No nearby donors found.</p>"; return; }

      filtered.forEach(d=>{
        const el = document.createElement('div');
        el.innerHTML = `<strong>${d.name} (${d.blood})</strong><div>City: ${d.city}</div><div>Distance: ${d.distance} km</div><div>Contact: ${d.contact}</div><button data-id="${d.id}">Mark Contacted</button>`;
        resultsBox.appendChild(el);
      });

      Array.from(document.querySelectorAll('[data-id]')).forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id=btn.getAttribute('data-id'); 
          const arr=load(DONOR_KEY); 
          const d=arr.find(x=>x.id===id); 
          if(d){ d.avail='unavailable'; save(DONOR_KEY,arr); alert('Marked as unavailable (demo)'); refresh();}
        });
      });
    }

    // Initialize demo donors if none
    (function init(){
      if(!localStorage.getItem(DONOR_KEY)){
        save(DONOR_KEY, [
          { id:uid(), name:'Asha', blood:'O+', city:'delhi', contact:'9876500001', avail:'available' },
          { id:uid(), name:'Ravi', blood:'B-', city:'delhi', contact:'9876500002', avail:'available' }
        ]);
      }
      refresh();
    })();
  </script>

  <!-- Load Geometry library for distance calculation -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkBL-z3h16AxHRkgAMEjti95S8dCi2JNE&libraries=geometry"></script>
</body>
</html>
