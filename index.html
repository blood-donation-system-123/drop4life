<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DROP4Life — Demo</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;color:#222;margin:0;padding:0}
    header{background:#c62828;color:#fff;padding:20px;text-align:center}
    .container{max-width:980px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:8px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    label{display:block;margin:8px 0;font-size:14px}
    input,select,button{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px}
    button{background:#c62828;color:#fff;border:none;cursor:pointer}
    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    footer{text-align:center;padding:12px;color:#666}
  </style>
</head>
<body>
  <header>
    <h1>DROP4Life (Demo)</h1>
    <div>Simple donor registration & request prototype — data saved locally in browser</div>
  </header>

  <main class="container">
    <section class="flex">
      <div class="card col">
        <h2>Register as Donor</h2>
        <form id="donorForm">
          <label>Name<input id="donorName" required /></label>
          <label>Blood Group
            <select id="donorBlood" required>
              <option value="">Select</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
            </select>
          </label>
          <label>City<input id="donorCity" required /></label>
          <label>Contact<input id="donorContact" required /></label>
          <label>Availability
            <select id="donorAvail" required>
              <option value="available">Available</option>
              <option value="unavailable">Unavailable</option>
            </select>
          </label>
          <button type="submit">Register Donor</button>
        </form>
      </div>

      <div class="card col">
        <h2>Request Blood</h2>
        <form id="requestForm">
          <label>Required Blood Group
            <select id="reqBlood" required>
              <option value="">Select</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
            </select>
          </label>
          <label>City<input id="reqCity" required /></label>
          <label>Urgency
            <select id="reqUrgency"><option value="normal">Normal</option><option value="urgent">Urgent</option></select>
          </label>
          <label>Your Contact<input id="reqContact" required /></label>
          <button type="submit">Find Donors</button>
        </form>
      </div>
    </section>

    <div class="card" id="results">
      <h2>Results & History</h2>
      <div id="messages">Donors registered: 0</div>
      <div id="matches"></div>
      <ul id="historyList"></ul>
    </div>
  </main>

  <footer>Demo: data kept locally in your browser. For production, a server & database are required.</footer>

  <!-- Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>

  <script>
    const DONOR_KEY = 'drop4life_donors';
    const REQ_KEY = 'drop4life_requests';
    const uid = ()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    const load = k => JSON.parse(localStorage.getItem(k)||'[]');
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

    function refresh() {
      const donors = load(DONOR_KEY);
      document.getElementById('messages').innerText = 'Donors registered: '+donors.length;
      const reqs = load(REQ_KEY);
      const h = document.getElementById('historyList'); h.innerHTML='';
      if(reqs.length===0) h.innerHTML='<li>No requests yet</li>';
      reqs.forEach(r=>{
        const li=document.createElement('li'); 
        li.textContent = r.blood+' in '+r.city+' — '+(r.urgency||'normal'); 
        h.appendChild(li);
      });
    }

    // ------------------ Donor Form with Geocoding ------------------
    document.getElementById('donorForm').addEventListener('submit', e=>{
      e.preventDefault();
      const name = document.getElementById('donorName').value.trim();
      const blood = document.getElementById('donorBlood').value;
      const city = document.getElementById('donorCity').value.trim();
      const contact = document.getElementById('donorContact').value.trim();
      const avail = document.getElementById('donorAvail').value;

      // Geocode city to lat/lng
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: city }, function(results, status) {
        if (status === 'OK') {
          const lat = results[0].geometry.location.lat();
          const lng = results[0].geometry.location.lng();

          const donor = { id:uid(), name, blood, city: city.toLowerCase(), contact, avail, lat, lng };
          const arr = load(DONOR_KEY); arr.push(donor); save(DONOR_KEY, arr);
          alert('Donor saved (demo)');
          e.target.reset();
          refresh();
        } else {
          alert('Invalid city. Please enter a valid location.');
        }
      });
    });

    // ------------------ Request Form ------------------
    document.getElementById('requestForm').addEventListener('submit', e=>{
      e.preventDefault();
      const r = { 
        id:uid(),
        blood:document.getElementById('reqBlood').value,
        city:document.getElementById('reqCity').value.trim().toLowerCase(),
        urgency:document.getElementById('reqUrgency').value,
        contact:document.getElementById('reqContact').value,
        time:new Date().toISOString()
      };
      const arr = load(REQ_KEY); arr.unshift(r); save(REQ_KEY,arr);
      alert('Search started (demo)');
      findAndShow(r);
      e.target.reset();
      refresh();
    });

    // ------------------ Search and Display ------------------
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function findAndShow(request){
      const donors = load(DONOR_KEY).filter(d=> d.blood===request.blood && d.avail==='available');
      const mdiv = document.getElementById('matches'); mdiv.innerHTML='';

      if(donors.length===0){ mdiv.innerHTML='<p>No donors found.</p>'; return;}

      // Geocode requester city
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: request.city }, function(results, status){
        if(status==='OK'){
          const userLat = results[0].geometry.location.lat();
          const userLng = results[0].geometry.location.lng();

          donors.forEach(d=> d.distance = getDistance(userLat, userLng, d.lat, d.lng));
          donors.sort((a,b)=>a.distance - b.distance);

          donors.forEach(d=>{
            const el = document.createElement('div');
            el.className = 'card';
            el.style.marginBottom = '10px';
            el.style.padding = '8px';
            el.innerHTML = `
              <strong>${d.name} (${d.blood})</strong><br>
              City: ${d.city}<br>
              Distance: ${d.distance.toFixed(2)} km<br>
              Contact: ${d.contact}<br>
              <button onclick="markUnavailable('${d.id}')">Mark Contacted</button>
            `;
            mdiv.appendChild(el);
          });
        } else { alert('Invalid requester city.'); }
      });
    }

    // ------------------ Mark Contacted ------------------
    function markUnavailable(id){
      const arr = load(DONOR_KEY);
      const donor = arr.find(d=>d.id===id);
      if(donor){ donor.avail='unavailable'; save(DONOR_KEY, arr); alert('Marked as unavailable'); refresh(); }
    }

    // ------------------ Initialize ------------------
    (function init(){
      if(!localStorage.getItem(DONOR_KEY)){
        save(DONOR_KEY, [
          { id:uid(), name:'Asha', blood:'O+', city:'delhi', contact:'9876500001', avail:'available', lat:28.6139, lng:77.2090 },
          { id:uid(), name:'Ravi', blood:'B-', city:'delhi', contact:'9876500002', avail:'available', lat:28.6139, lng:77.2090 }
        ]);
      }
      refresh();
    })();
  </script>
</body>
</html>
