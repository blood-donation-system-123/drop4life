<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>DROP4Life — Demo</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;color:#222;margin:0;padding:0}
    header{background:#c62828;color:#fff;padding:20px;text-align:center}
    .container{max-width:980px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:8px;padding:14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    label{display:block;margin:8px 0;font-size:14px}
    input,select,button{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px}
    button{background:#c62828;color:#fff;border:none;cursor:pointer}
    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    footer{text-align:center;padding:12px;color:#666}
  </style>
</head>
<body>
  <header>
    <h1>DROP4Life (Demo)</h1>
    <div>Simple donor registration & request prototype — data saved locally in browser</div>
  </header>

  <main class="container">
    <section class="flex">
      <!-- Donor Registration -->
      <div class="card col">
        <h2>Register as Donor</h2>
        <form id="donorForm">
          <label>Name<input id="donorName" required /></label>
          <label>Blood Group
            <select id="donorBlood" required>
              <option value="">Select</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
            </select>
          </label>
          <label>City<input id="donorCity" required /></label>
          <label>Contact<input id="donorContact" required /></label>
          <label>Availability
            <select id="donorAvail" required>
              <option value="available">Available</option>
              <option value="unavailable">Unavailable</option>
            </select>
          </label>
          <button type="submit">Register Donor</button>
        </form>
      </div>

      <!-- Blood Request -->
      <div class="card col">
        <h2>Request Blood</h2>
        <form id="requestForm">
          <label>Required Blood Group
            <select id="reqBlood" required>
              <option value="">Select</option>
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
            </select>
          </label>
          <label>City<input id="reqCity" required /></label>
          <label>Urgency
            <select id="reqUrgency"><option value="normal">Normal</option><option value="urgent">Urgent</option></select>
          </label>
          <label>Your Contact<input id="reqContact" required /></label>
          <button type="submit">Find Donors</button>
        </form>
      </div>
    </section>

    <!-- Results & history -->
    <div class="card">
      <h2>Results & History</h2>
      <div id="messages">Donors registered: 0</div>
      <div id="matches"></div>
      <ul id="historyList"></ul>
    </div>
  </main>

  <footer>Demo: data kept locally in your browser. For production, a server & database are required.</footer>

  <script>
    const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const apiKey = "AIzaSyDkBL-z3h16AxHRkgAMEjti95S8dCi2JNE"; // your API key

    // Save donor
    function saveDonor(event) {
      event.preventDefault();
      const name = document.getElementById("donorName").value;
      const blood = document.getElementById("donorBlood").value;
      const city = document.getElementById("donorCity").value;
      const contact = document.getElementById("donorContact").value;
      const avail = document.getElementById("donorAvail").value;
      if (!name || !blood || !city || !contact) { alert("Please fill all fields"); return; }

      let donors = JSON.parse(localStorage.getItem("donors")) || [];
      donors.push({ id: uid(), name, blood, city, contact, avail });
      localStorage.setItem("donors", JSON.stringify(donors));
      alert("Donor added successfully!");
      document.getElementById("donorForm").reset();
      refresh();
    }

    // Get coordinates using Google Maps API
    async function getCoordinates(city) {
      const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(city)}&key=${apiKey}`);
      const data = await response.json();
      if (data.status === "OK") {
        const loc = data.results[0].geometry.location;
        return { lat: loc.lat, lng: loc.lng };
      } else {
        return null;
      }
    }

    // Distance calculation
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Search donor
    async function searchDonor() {
      const blood = document.getElementById("reqBlood").value;
      const city = document.getElementById("reqCity").value.trim();
      if (!blood || !city) return;
      const coords = await getCoordinates(city);
      if (!coords) { alert("Invalid city"); return; }

      let donors = JSON.parse(localStorage.getItem("donors")) || [];
      let filtered = donors.filter(d => d.blood===blood && d.avail==="available")
        .map(d => ({ ...d, distance: getDistance(coords.lat, coords.lng, 0, 0) }));

      const resultDiv = document.getElementById("matches");
      resultDiv.innerHTML = "";
      if (filtered.length === 0) { resultDiv.innerHTML="<p>No matching donor found.</p>"; return; }

      filtered.forEach(d => {
        const div = document.createElement("div");
        div.style.border="1px solid #ccc"; div.style.padding="10px"; div.style.marginBottom="10px";
        div.innerHTML = `<strong>${d.name} (${d.blood})</strong><br>City: ${d.city}<br>Contact: ${d.contact}`;
        resultDiv.appendChild(div);
      });
    }

    function refresh() {
      const donors = JSON.parse(localStorage.getItem("donors")) || [];
      document.getElementById("messages").innerText = "Donors registered: "+donors.length;
    }

    document.getElementById("donorForm").addEventListener("submit", saveDonor);
    document.getElementById("requestForm").addEventListener("submit", async e => { e.preventDefault(); await searchDonor(); });

    // Init demo donors
    (function init() {
      if (!localStorage.getItem("donors")) {
        localStorage.setItem("donors", JSON.stringify([
          { id: uid(), name:"Amit Sharma", blood:"A+", city:"Delhi", contact:"9876500001", avail:"available" },
          { id: uid(), name:"Priya Mehta", blood:"B+", city:"Mumbai", contact:"9876500002", avail:"available" }
        ]));
      }
      refresh();
    })();
  </script>
</body>
</html>
